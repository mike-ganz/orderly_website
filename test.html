<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Microsoft OAuth</title>
</head>
<body>
    <button id="signInButton">Log in with Microsoft</button>
    <div id="tokenResult"></div>

    <script>
        const clientId = 'f8026b89-53cd-4208-ac5a-dec826820fad'; // Replace with your client ID
        const redirectUri = encodeURIComponent('https://www.joinorderly.com/test'); // Replace with your redirect URI
        const tenantId = 'common';

        // PKCE Helper Functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        // For plain method, codeChallenge is the same as codeVerifier
        const codeVerifier = generateCodeVerifier();
        const codeChallenge = codeVerifier;

        document.getElementById('signInButton').addEventListener('click', function() {
            window.location.href = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&response_mode=query&scope=openid email profile offline_access Mail.Read&code_challenge=${codeChallenge}&code_challenge_method=plain`;
        });

        function handleAuthRedirect() {
            if (window.location.search.includes("code=")) {
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get("code");

                // Token exchange endpoint
                const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;

                // Prepare data for token exchange
                const data = new URLSearchParams();
                data.append('client_id', clientId);
                data.append('code', authCode);
                data.append('redirect_uri', decodeURIComponent(redirectUri));
                data.append('grant_type', 'authorization_code');
                data.append('code_verifier', codeVerifier);

                // Exchange code for token
                fetch(tokenUrl, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: data
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tokenResult').textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('tokenResult').textContent = 'Error: ' + error;
                });
            }
        }

        handleAuthRedirect();
    </script>
</body>
</html>

